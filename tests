#!/bin/bash

# Decompose tests, for my sanity

# Get the location of the script. Not the symlink.
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

# Source decompose functions
source "$DIR/decompose-functions"
source "$DIR/completion/decompose-bash-completion-functions"

# Make sure nothing is printed on stderr
_decompose-test-no-stderr() {
  local error_output=$(./decompose 2>&1 1>/dev/null)
  if [ -n "$error_output" ]; then
    echo "decompose had errors:"
    echo $error_output
    return 1
  fi
  return 0
}

# Test help function
_decompose-test-help-test() {
  local output=$(decompose-print-help)
  if [ ! -z "$ouput" ]; then
    echo "Help didn't print anything"
    return 1
  fi
  local error_output=$(decompose-print-help 2>&1 1>/dev/null)
  if [ -n "$error_output" ]; then
    echo "Help had errors:"
    echo $error_output
    return 1
  fi

  return 0
}

_decompose-test-run-tests() {
  local _decompose_tests_to_run=( 'no-stderr' 'help-test' )
  
  for test in ${_decompose_tests_to_run[@]}; do
    _decompose-test-$test
    error_code="$?"
    
    echo -n "Test '$test': "
    if [ "$error_code" -gt "0" ]; then
      echo "FAIL with return code '$error_code'"
    else
      echo "PASS" 
    fi
  done
}

_decompose-test-run-tests
